const CACHE_NAME="story-map-v1",DATA_CACHE_NAME="story-map-data-v1",urlsToCache=["/","/index.html","/app.bundle.js","/styles.css","https://unpkg.com/leaflet@1.9.4/dist/leaflet.css","https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"];async function syncStories(){try{const e=await openDB(),t=e.transaction("pending-stories","readonly").objectStore("pending-stories"),o=await t.getAll();console.log("[Service Worker] Syncing stories:",o.length);for(const t of o)try{const o=new FormData;if(o.append("description",t.description),o.append("photo",t.photo),t.lat&&o.append("lat",t.lat),t.lon&&o.append("lon",t.lon),(await fetch("https://story-api.dicoding.dev/v1/stories",{method:"POST",headers:{Authorization:`Bearer ${t.token}`},body:o})).ok){const o=e.transaction("pending-stories","readwrite").objectStore("pending-stories");await o.delete(t.id),console.log("[Service Worker] Story synced:",t.id),self.registration.showNotification("Story Synced",{body:"Your offline story has been posted successfully!",icon:"/icons/icon-192x192.png"})}}catch(e){console.error("[Service Worker] Error syncing story:",e)}}catch(e){console.error("[Service Worker] Error in syncStories:",e)}}function openDB(){return new Promise(((e,t)=>{const o=indexedDB.open("story-map-db",1);o.onerror=()=>t(o.error),o.onsuccess=()=>e(o.result),o.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("stories")||t.createObjectStore("stories",{keyPath:"id"}),t.objectStoreNames.contains("pending-stories")||t.createObjectStore("pending-stories",{keyPath:"id",autoIncrement:!0}),t.objectStoreNames.contains("favorites")||t.createObjectStore("favorites",{keyPath:"id"})}}))}self.addEventListener("install",(e=>{console.log("[Service Worker] Installing..."),e.waitUntil(caches.open(CACHE_NAME).then((e=>(console.log("[Service Worker] Caching app shell"),e.addAll(urlsToCache))))),self.skipWaiting()})),self.addEventListener("activate",(e=>(console.log("[Service Worker] Activating..."),e.waitUntil(caches.keys().then((e=>Promise.all(e.map((e=>{if(e!==CACHE_NAME&&e!==DATA_CACHE_NAME)return console.log("[Service Worker] Removing old cache:",e),caches.delete(e)})))))),self.clients.claim()))),self.addEventListener("fetch",(e=>{const{request:t}=e;"https://story-api.dicoding.dev"!==new URL(t.url).origin?e.respondWith(caches.match(t).then((e=>e||fetch(t).then((e=>caches.open(CACHE_NAME).then((o=>(o.put(t,e.clone()),e)))))))):e.respondWith(caches.open(DATA_CACHE_NAME).then((e=>fetch(t).then((o=>("GET"===t.method&&200===o.status&&e.put(t,o.clone()),o))).catch((()=>e.match(t))))))})),self.addEventListener("push",(e=>{console.log("[Service Worker] Push received");let t={title:"Story Map",body:"You have a new notification",icon:"/icons/icon-192x192.png",badge:"/icons/icon-96x96.png",data:{url:"/"}};if(e.data)try{const o=e.data.json();t={title:o.title||t.title,body:o.options?.body||t.body,icon:o.options?.icon||t.icon,badge:o.options?.badge||t.badge,data:{url:o.options?.data?.url||t.data.url}}}catch(e){console.error("Error parsing push data:",e)}e.waitUntil(self.registration.showNotification(t.title,{body:t.body,icon:t.icon,badge:t.badge,data:t.data,actions:[{action:"view",title:"Lihat Detail"},{action:"close",title:"Tutup"}]}))})),self.addEventListener("notificationclick",(e=>{if(console.log("[Service Worker] Notification clicked"),e.notification.close(),"view"===e.action)e.waitUntil(clients.openWindow(e.notification.data.url||"/"));else{if("close"===e.action)return;e.waitUntil(clients.openWindow(e.notification.data.url||"/"))}})),self.addEventListener("sync",(e=>{console.log("[Service Worker] Background sync:",e.tag),"sync-stories"===e.tag&&e.waitUntil(syncStories())}));